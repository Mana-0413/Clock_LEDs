# Clock_LEDs

このプログラムは「ProjectKit-vol.4」の第4章の製作物のものです。


## プログラムの流れ

本プログラムは、1つのソースファイルと1つのヘッダファイルによって構成されています。それぞれの役割について以下で説明します。

### ヘッダファイル

ヘッダファイル（`arduino_secrets.h`）には、Wi-Fi接続に必要なSSIDとパスワードが記述されています。  
ネットワーク情報を分離することで、ソースコードを公開しても情報が流出しないように設計されています。

### ソースファイル

このプログラムは、以下の5つの主要な処理ブロックで構成されています。

- Wi-Fi接続とNTPによる時刻取得  
- RTC（DS3232）によるオフライン時刻取得  
- 光センサによる明暗判定  
- LED表示処理（アナログ時計表示）  
- クロック音やエラー通知の制御  

プログラムは `setup()` 関数で「オンラインモード」を試み、`arduino_secrets.h` に記述されたSSIDとパスワードでWi-Fi接続とNTPによる時刻同期を行います。

接続に失敗した場合は「オフラインモード」に移行し、RTCの値を読み込みます。さらに、RTCに値が存在しない場合は、「デバッグモード」が有効なら指定時刻をRTCに書き込み、無効な場合はエラー通知とともに異常終了します。

`loop()` 関数では1秒ごとにRTCから現在時刻を取得し、時針・分針に対応するLEDを点灯します。明暗判定を行ったうえで、必要に応じて秒針表示とクロック音の出力も行います。

---

## 使用ライブラリの解説

### `arduino_secrets.h`

前述のとおり、SSIDとパスワードを記述するためのヘッダファイルです。

### `<WiFiS3.h>`

Wi-Fi接続用ライブラリ。SSIDとパスワードを使ってインターネット接続を行い、NTPサーバへのアクセスに使用されます。

### `<TimeLib.h>`

現在時刻の保持・取得を行うライブラリ。`setTime()` や `now()` といった関数で、NTPで取得したUNIX時間を時刻として設定し、RTCと連携します。

### `<DS3232RTC.h>`

DS3232などのRTCモジュールと連携するライブラリ。NTPから取得した時刻のRTC書き込みや、現在時刻の読み出しに使用します。

### `<FastLED.h>`

アドレサブルLED（WS2812/NeoPixel等）を柔軟に制御できる高性能ライブラリ。時計表示のLED点灯・色制御に使用され、時針・分針・秒針や目盛りを視覚的に表現します。

---

## 関数解説

### `setup()`

初期化処理を行います。Wi-Fi接続、NTP時刻同期、RTCの初期化を通じて、オンライン／オフライン／デバッグの各モードへ分岐します。

### `sync_time_with_ntp()`

NTPサーバから時刻を取得してRTCへ書き込みます。取得に失敗した場合は「オフラインモード」に移行します。

### `handle_offline_mode()`

RTCから現在時刻を読み出します。未設定の場合は、デバッグモードの有無に応じて指定時刻の書き込みまたは異常終了処理を行います。

### `loop()`

1秒ごとに時刻を更新し、LEDによる時刻表示とクロック音の出力を行います。内部で複数の表示用関数を呼び出します。

### `is_shine()`

CDSセル（光センサ）からの値をもとに、部屋の明るさを判定します。判定のしきい値は `light_threshold` により設定されます。

### `shine_mode()`

部屋が明るい場合に秒針を表示し、クロック音を出力します。暗い場合はこの処理をスキップします。

### `display_clock()`

以下の3つの関数を呼び出し、アナログ時計のLED表示を構成します。

- `display_scale5()`  
- `set_hour_led()`  
- `set_minute_led()`

### `display_scale5()`

5分ごとの目盛りに対応するLEDを設定します。

### `get_mapped_pos(pos)`

LEDの起点を調整し、指定した位置からのオフセットでLEDを点灯させます。

### `set_hour_led()`

時針を示すLEDを中心に、その前後に補助LEDを点灯させます。他の針や目盛りと重なった場合、補助LEDは省略されます。

### `set_minute_led()`

分針のLEDを設定します。目盛りと重なった場合は分針が優先されます。

### `set_second_led()`

秒針を設定します。分針と重なった場合は色を変更して重なりを示します。
